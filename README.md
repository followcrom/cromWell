# 🏃‍♂️ CromWell 🍋🥝🍌🍐🥥🍈

Pull Fitbit health data into InfluxDB and visualize it with Grafana. All automated via a cron job that runs once a day. It’s your personal observability pipeline! 🚀

##  🖼️ Grafana Visualization

📊 [Dashboard](https://followcrom.grafana.net/d/97b9809e-408a-4f96-8f92-333e7167d952/cromwell-s-fitbit-board)


## 🛠️ Local EDA

Just activate the venv and run jupyter lab:

```bash
source cw_venv/bin/activate
jupyter lab
```

## On the dobox

```bash
chmod 755 run_fitbit2influx.sh
chown root:root run_fitbit2influx.sh
```

## 📦 Project Overview

`fitbit2influx.py` is a Python script that:

✅ Authenticates with the Fitbit API  
📥 Pulls detailed health metrics (sleep, activity, HR, SpO₂, etc.)  
🛢 Stores that data in InfluxDB  
📈 Feeds your Grafana dashboards with up-to-date personal metrics  

`run_fitbit2influx.sh` is a shell script that:

📬 Sends an email alert if anything goes wrong

---

## 🐍 Create Virtual Environment

```bash
python3 -m venv cw_venv  
source cw_venv/bin/activate  
pip install -r requirements.txt  
```

## 🔐 Fitbit API Credentials
Make sure you've registered an app on the Fitbit developer portal and have:

- client_id
- client_secret
- A valid access token (or refresh logic)

These should be stored securely in a .env file or secure vault, loaded by the script.

## 📁 Project Structure

```
cromwell/
├── fitbit2influx.py        # Main Python script
├── run_fitbit2influx.sh    # Shell wrapper for running the script with logging and error handling
├── cw_venv/                # Python virtual environment
├── data/                   # JSON data files
├── fitbit_data.log         # Log file for Fitbit data
├── cromwell_cron.log       # Log file for cron job execution
├── requirements.txt        # Python dependencies
├── .env                    # Environment variables for configuration
├── .gitignore              # Git ignore file
└── README.md
```

## InfluxDB

```bash
influx bucket list
```

List Measurements:

```bash
influx query 'import "influxdata/influxdb/schema"
  schema.measurements(bucket: "cromwell-fitbit-2")'
```

List Tag Keys:
Tags are key-value pairs that store metadata and are indexed for fast querying. To see all the tag keys for a specific measurement:

```bash
influx query 'import "influxdata/influxdb/schema"
schema.measurementTagKeys(
bucket: "cromwell-fitbit-2",
measurement: "HRV"
)'
```

List Field Keys:
Fields are the key-value pairs that store your actual time series data (e.g., temperature, pressure). Unlike tags, fields are not indexed. To see the field keys for a measurement:

```bash
influx query 'import "influxdata/influxdb/schema"
  schema.measurementFieldKeys(
    bucket: "cromwell-fitbit-2",
    measurement: "HRV"
  )'
```

List Series:
A series is a unique combination of measurement, tag set, and field key. To see all series in a bucket:

```bash
influx query 'from(bucket: "cromwell-fitbit-2") |> range(start: -1d) |> filter(fn: (r) => r._measurement == "HeartRate_Intraday") |> sort(columns: ["_time"]) |> limit(n: 200)'
```


Query Bounds vs. Data Timestamp 📚

When you run a query in InfluxDB, you often specify a time range using the `range(start: -7d)` function. This tells InfluxDB to return data points within the last 7 days.
the _start and _stop columns show the time window of the query you just ran (ie range(start: -7d)). _time: This is the important column, as it's the actual timestamp associated with your data point (_value).


Think of it like searching a library's online catalog:

range(start: -7d): This is your search instruction to the librarian: "Please find me all the books published in the last 7 days."

_start and _stop: This is the note at the top of the printout the librarian gives you, saying: Results for your query from August 3rd to August 10th. It just defines the boundaries of the search you requested.

_time: This is the actual publication date printed inside each individual book. It's the timestamp that belongs to that specific piece of data.

The _start and _stop columns are ephemeral metadata generated by InfluxDB's query engine every time you run a query. They exist only in the query results to give you context about the time window that was searched.

The only time-related column that is permanently stored in the database alongside your values is the _time column.

To put it simply:

Stored in the Database: _time, _measurement, _field, _value, and any tags you have (e.g., Device).

Generated by each Query: _start, _stop, and other metadata columns like table.

---

## Issues

When you're in BST (UTC+1), daily measurements like "2025-08-03" were being converted to "2025-08-03T00:00:00" in BST, which becomes "2025-08-02T23:00:00+00:00" in UTC - shifting the date to the previous day.
The Solution

Added a daily_measurement parameter to safe_datetime_parse()
For daily measurements: Instead of using midnight (00:00:00), I use noon (12:00:00) in your local timezone
Why noon? Because noon BST (12:00:00+01:00) converts to 11:00:00 UTC - still on the correct date!

Results
Now your daily measurements will show:

Before: 2025-08-02T23:00:00+00:00 ❌ (wrong date)
After: 2025-08-03T11:00:00+00:00 ✅ (correct date)

What's Updated
I've updated all the daily measurement calls:

HRV, Breathing Rate, Skin Temperature, SPO2 Daily
Activity summaries (steps, calories, etc.)
Heart Rate Zones and Resting HR

Note: Weight measurements keep their original time handling since they already include specific times, and intraday data (heart rate, steps) keeps the original handling since they have specific timestamps that should be preserved.

This is standard practice

Many data systems do this - assign canonical timestamps to daily aggregates
Weather data, financial daily closes, etc. all work this way
The "collection time" and "data timestamp" are completely separate concepts

Example Timeline:
August 3rd: You live your day, Fitbit tracks everything
August 4th 3:00 AM: Script runs and collects yesterday's data
August 4th 3:05 AM: Data gets written to InfluxDB with timestamp "August 3rd 11:00 AM UTC"
Benefits of This Approach:

Consistent daily timestamps: All daily data points to the same time each day
Correct date grouping: Data appears on the right date in graphs/queries
No timezone confusion: Everything stays on the intended date

<br>

## 📅 Commit Activity 🕹️

![GitHub last commit](https://img.shields.io/github/last-commit/followcrom/cromWell)
![GitHub commit activity](https://img.shields.io/github/commit-activity/m/followcrom/cromWell)
![GitHub repo size](https://img.shields.io/github/repo-size/followcrom/cromWell)

## ✍ Authors 

🌍 followCrom: [followcrom.com](https://followcrom.com/index.html) 🌐

📫 followCrom: [get in touch](https://followcrom.com/contact/contact.php) 👋

[![Static Badge](https://img.shields.io/badge/followcrom-online-blue)](http://followcrom.com)